<?php

/**
 * 设置配置布局头部结构
 */
function setConfigLayoutHeader()
{
    ?>

    <div id="custom-config-layout">
        <div class="config-sidebar">
            <ul id="config-nav">
            </ul>
        </div>

        <div class="config-content">
            <?php
}

/**
 * 设置配置布局尾部结构
 */
function setConfigLayoutFooter()
{
    ?>
        </div>
    </div>
    <?php
}

function themeConfig($form)
{
    setConfigLayoutHeader();

    $avatarUrl = new Typecho_Widget_Helper_Form_Element_Select(
        'avatarUrl', // 变量名，用于模板调用
        array(
            'v2ex' => _t('v2ex'),
            'loli' => _t('loli'),
            'gravatar' => _t('gravatar')
        ),           // 选项数组：'值' => '显示文字'
        'v2ex',      // 默认选中值
        _t('头像源'), // 设置标题
        NULL // 设置描述
    );

    // 将设置项添加到表单中
    $form->addInput($avatarUrl);

    // 1. 模式切换
    $bgMode = new Typecho_Widget_Helper_Form_Element_Select(
        'bgMode',
        array('image' => '图片模式', 'color' => '纯色模式'),
        'image',
        _t('背景模式'),
        _t('切换后，下方会自动显示对应的输入框')
    );
    $form->addInput($bgMode);

    // 2. 图片地址输入框
    $bgImage = new Typecho_Widget_Helper_Form_Element_Text(
        'bgImage',
        NULL,
        NULL,
        _t('图片 URL'),
        _t('请输入背景图片的完整路径')
    );
    $form->addInput($bgImage);

    // 3. 颜色代码输入框
    $bgColor = new Typecho_Widget_Helper_Form_Element_Text(
        'bgColor',
        NULL,
        '#FFFFFF',
        _t('颜色代码'),
        _t('请输入 Hex 颜色值，例如 #f0f0f0')
    );
    $form->addInput($bgColor);

    setConfigLayoutFooter();
    setStyle();
    setScript();
}


/**
 * 设置样式
 */
function setStyle()
{
    ?>
    <style>
        /* 侧边栏容器 */
        .config-sidebar {
            position: fixed;
            top: 150px;
            right: 50px;
            width: 180px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            z-index: 999;
        }

        .config-sidebar a.active {
            background-color: #467b96;
            color: #fff;
            font-weight: bold;
        }

        .config-sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .config-sidebar li {
            margin-bottom: 8px;
        }

        .config-sidebar a {
            text-decoration: none;
            color: #666;
            font-size: 14px;
            display: block;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .config-sidebar a:hover {
            background-color: #f3f3f3;
            color: #467b96;
        }

        /* 主内容区域微调 */
        .config-content h2 {
            border-bottom: 2px solid #467b96;
            padding-bottom: 10px;
            margin-top: 40px;
            color: #467b96;
        }

        /* 适配 Typecho 原生样式 */
        .typecho-page-main {
            background: none !important;
        }
    </style>
    <?php
}

/**
 * 设置脚本
 */
function setScript()
{
    ?>
    <script>
        window.onload = function () {
            // 背景模式切换
            var selector = document.getElementsByName('bgMode')[0];
            var imgContainer = document.getElementsByName('bgImage')[0]?.closest('li');
            var colorContainer = document.getElementsByName('bgColor')[0]?.closest('li');
            function updateVisibility() {
                if (!selector) return;
                if (selector.value === 'image') {
                    if (imgContainer) imgContainer.style.display = '';
                    if (colorContainer) colorContainer.style.display = 'none';
                } else {
                    if (imgContainer) imgContainer.style.display = 'none';
                    if (colorContainer) colorContainer.style.display = '';
                }
            }
            if (selector) selector.onchange = updateVisibility;
            updateVisibility();

            // 侧边栏
            const nav = document.getElementById('config-nav');
            const headers = document.querySelectorAll('.config-content h2');

            headers.forEach((header, index) => {
                const id = 'section-' + index;
                header.setAttribute('id', id);

                const li = document.createElement('li');
                li.innerHTML = `<a href="#${id}">${header.innerText}</a>`;
                li.onclick = (e) => {
                    e.preventDefault();
                    header.scrollIntoView({ behavior: 'smooth' });
                };
                nav.appendChild(li);
            });

            // 快捷键保存
            document.addEventListener('keydown', function (e) {
                // 判断是否按下 S 键 (KeyCode 83)
                // 同时判断 Windows 的 Ctrl 或 Mac 的 Command (metaKey)
                if ((e.ctrlKey || e.metaKey) && e.keyCode === 83) {

                    // 阻止浏览器默认的保存网页行为
                    e.preventDefault();

                    // 1. 找到 Typecho 的提交按钮
                    // Typecho 默认的提交按钮通常是 type="submit"
                    const submitBtn = document.querySelector('button[type="submit"]');

                    if (submitBtn) {
                        // 2. 视觉反馈：改变按钮文字或状态，让用户知道正在保存
                        submitBtn.innerText = "正在保存...";
                        submitBtn.style.opacity = "0.7";

                        // 3. 触发点击保存
                        submitBtn.click();

                        // 可选：弹出一个简单的提示（Typecho 默认提交后会刷新页面，所以提示通常转瞬即逝）
                        console.log('快捷键保存触发成功');
                    }
                }
            });
        };
    </script>
    <?php
}